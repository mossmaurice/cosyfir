# **CO**ntrol **SY**stem **F**or **IR**igation

Cosyfir helps you watering your plants. The node software runs on an STM32 ARM Cortex microcontroller. The server software runs on UNIX-based system like Debian. The following picture depicts an example setup:

     []        +--+       +--+         \  /        \o/
     []  <->   |  |  <->  |  |  <->   ( )( )  <->   |
     \/  LoRa  +--+       +--+  MQTT   (  )   SSH  / \

    Sensor    LoRaWAN     TTN          RPi        User
     Node     Gateway    Server       @home
    ./node/* (Not part of cosyfir)  ./cosyfird/*

This readme describes both the server (e.g. Raspberry Pi) and the sensor node software in the following sections.

## Prerequisites

E.g. on a Debian based system install the following packages:

    sudo apt install clang-format stm32flash arm-none-eabi-gcc gcc cmake

## Build everything

    ./build_all.sh

If you want to run the tests after the build add "test".

    ./build_all.sh test

For a clean build add the parameter "clean" instead of "test".

## cosyfir daemon

Currently two applications are available:

* cosyfir-sub: Receives messages from nodes via the TTN server
* cosyfir-pub: Publishes messages to nodes

[libmosquittopp](https://mosquitto.org/) is used as MQTT library.

    sudo apt install libmosquittopp-dev libssl-dev libyaml-cpp-dev

## Node

This section describes the node software which communicates based on [LoRa](https://en.wikipedia.org/wiki/LoRa) and [TTN](https://www.thethingsnetwork.org/).

### Required hardware and software

* [LSN50 v1.2](https://wiki.dragino.com/index.php?title=Lora_Sensor_Node-LSN50) from Dragino
  * STM32L072CZT6
  * Semtech SX1276
  * Battery
  * IP66 case
* FTDI UART cable
* Linux machine
  * [stm32flash](https://sourceforge.net/p/stm32flash/wiki/Home/) version  >=0.5

stm32flash should be available with most distros, e.g. for Debian do:

    sudo apt install stm32flash

### How to flash

Connected as described below:

    GND (black):  JP4 Pin11 GND
    TXD (orange): JP3 Pin9 PA3 (USART1)
    RXD (yellow): JP3 Pin10 PA2 (USART1)

Find out where your usbserial device is mounted:

    journalctl -k -n 100

And then from root, do:

    sudo stm32flash -w node/build/cosyfir-node /dev/ttyUSBx

#### Debugging (optional)

    sudo apt install stmlink-tools
    st-flash
    st-info
    st-utils

### What to configure in order to connect to [The Things Network](https://www.thethingsnetwork.org/)

Four identifers have to be added to the commissioning header (later done via CMake):

* **DevAddr:** 32-bit address (non-unique)
* **DevEUI:** 64-bit end-device identifier (unique) written usually on device box; add this to The Things Network under "Add application" (TODO add some screenshots)
* **AppEUI** or **JoinEUI**: 64-bit application identifier, generated by The Things Network, copy & paste from the webpage
* **AppKey**: data encryption key known to node and server, generated by The Things Network, copy & paste from the webpage

## Todo

* Add CMake flag for support of different sensors (e.g. temperature, soil moisture)
* Add LoRa stack as submodule
  * Add variable in CMake for TTN credentials?
